<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalStorage Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .user-info { background: #e8f4f8; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .error { background: #fee; border: 1px solid #fcc; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .success { background: #efe; border: 1px solid #cfc; padding: 15px; border-radius: 8px; margin: 20px 0; }
        pre { background: #f8f8f8; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç LocalStorage Debug Tool</h1>
        <p>This tool helps debug user authentication and localStorage data.</p>

        <div id="user-info"></div>
        <div id="api-test"></div>

        <button onclick="checkLocalStorage()">Check LocalStorage</button>
        <button onclick="testAPI()">Test API Call</button>
        <button onclick="clearLocalStorage()">Clear LocalStorage</button>
    </div>

    <script>
        function checkLocalStorage() {
            const userInfo = document.getElementById('user-info');

            try {
                const userData = localStorage.getItem('user');
                const token = localStorage.getItem('token');

                if (userData) {
                    const user = JSON.parse(userData);
                    userInfo.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ User Found in LocalStorage</h3>
                            <pre>${JSON.stringify(user, null, 2)}</pre>
                            <p><strong>User ID:</strong> ${user.id || 'Not found'}</p>
                            <p><strong>Name:</strong> ${user.name || user.firstName + ' ' + user.lastName || 'Not found'}</p>
                            <p><strong>Email:</strong> ${user.email || 'Not found'}</p>
                        </div>
                        <div class="user-info">
                            <h4>Token Status:</h4>
                            <p><strong>Token exists:</strong> ${token ? 'Yes' : 'No'}</p>
                            ${token ? `<p><strong>Token length:</strong> ${token.length} characters</p>` : ''}
                        </div>
                    `;
                } else {
                    userInfo.innerHTML = `
                        <div class="error">
                            <h3>‚ùå No User Data in LocalStorage</h3>
                            <p>The user is not logged in or localStorage is empty.</p>
                            <p>Please log in to the application first.</p>
                        </div>
                    `;
                }
            } catch (error) {
                userInfo.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Error Reading LocalStorage</h3>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function testAPI() {
            const apiTest = document.getElementById('api-test');

            try {
                const userData = localStorage.getItem('user');
                if (!userData) {
                    apiTest.innerHTML = `
                        <div class="error">
                            <h3>‚ùå No User Data</h3>
                            <p>Cannot test API without user data. Please log in first.</p>
                        </div>
                    `;
                    return;
                }

                const user = JSON.parse(userData);
                const userId = user.id;

                apiTest.innerHTML = '<p>üîÑ Testing API call...</p>';

                const response = await fetch('http://localhost/SmartScribe-main/public/index.php?resource=notes', {
                    method: 'GET',
                    headers: {
                        'X-User-ID': userId,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    apiTest.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ API Call Successful</h3>
                            <p>Found ${data.data ? data.data.length : 0} notes for user ID ${userId}</p>
                            ${data.debug ? `
                                <h4>Debug Info:</h4>
                                <ul>
                                    <li>User ID: ${data.debug.user_id}</li>
                                    <li>Notes Found: ${data.debug.notes_found}</li>
                                    <li>Total Notes in DB: ${data.debug.total_notes}</li>
                                </ul>
                            ` : ''}
                        </div>
                    `;
                } else {
                    apiTest.innerHTML = `
                        <div class="error">
                            <h3>‚ùå API Call Failed</h3>
                            <p>Error: ${data.error || 'Unknown error'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                apiTest.innerHTML = `
                    <div class="error">
                        <h3>‚ùå API Test Error</h3>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        function clearLocalStorage() {
            if (confirm('Are you sure you want to clear all localStorage data? This will log you out.')) {
                localStorage.clear();
                checkLocalStorage();
                document.getElementById('api-test').innerHTML = '';
                alert('LocalStorage cleared. Please refresh the page and log in again.');
            }
        }

        // Auto-check on page load
        window.onload = function() {
            checkLocalStorage();
        };
    </script>
</body>
</html>